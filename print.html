<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rust on Mobile</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Building a Rust library and use it across platforms">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Custom Elements -->
        <script type="text/javascript" src="https://static.ghamza.dev/js/code-line-highlight.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Fira+Code" rel="stylesheet">
        <style>
            code {
                font-family: 'Fira Code', sans-serif !important;
            }
        </style>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">2.</strong> Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="setup-makefile.html"><strong aria-hidden="true">2.1.</strong> Setup Makefile</a></li></ol></li><li class="chapter-item expanded "><a href="ios-glue.html"><strong aria-hidden="true">3.</strong> iOS Glue</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Android Glue</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> More Examples</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust on Mobile</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ghamza-rust/ghamza-rust.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rust--on-mobile-"><a class="header" href="#rust--on-mobile-">Rust 🦀 on Mobile 📱</a></h1>
<p>This small book describes how to use Rust and Mobile (android and iOS) together.</p>
<h2 id="who-is-this-book-for"><a class="header" href="#who-is-this-book-for">Who is this book for?</a></h2>
<p>This book is for anyone interested in compiling Rust to android or iOS for fast,
reliable code on the mobile. You should know some Rust, and be familiar with
Kotlin and Swift. You don't need to be an expert in any of them.</p>
<h2 id="how-to-read-this-book"><a class="header" href="#how-to-read-this-book">How to read this book?</a></h2>
<p>The book is written to be read from start to finish. You should follow
along:writing, compiling, and running the tutorial's code yourself.</p>
<p>We will build a rust library in this series and port it to different platforms.
We are calling it <code>libexa</code> (which stands for Example Library 🫣).</p>
<h2 id="low-level-control-with-high-level-ergonomics"><a class="header" href="#low-level-control-with-high-level-ergonomics">Low-Level Control with High-Level Ergonomics</a></h2>
<p>Rust gives programmers low-level control and reliable performance. It is free
from the non-deterministic garbage collection pauses that plague Kotlin/Swift.
Programmers have control over indirection, monomorphization, and memory layout.</p>
<h2 id="do-not-rewrite-everything"><a class="header" href="#do-not-rewrite-everything">Do <em>Not</em> Rewrite Everything</a></h2>
<p>Existing code bases don't need to be thrown away. You can start by porting your
most performance-sensitive Swift/Kotlin functions to Rust to gain immediate
benefits. And you can even stop there if you want to.</p>
<p>I strongly recommend <a href="https://www.rust-lang.org/tools/install">installing all of your Rust toolchains using rustup.</a></p>
<blockquote>
<p><em>The code of this tutorial is available on <a href="https://github.com/Ghamza-Jd/exa-lib">Ghamza-Jd/exa-lib</a></em></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup-"><a class="header" href="#setup-">Setup 🏗️</a></h1>
<h2 id="the-rust-toolchain"><a class="header" href="#the-rust-toolchain">The Rust Toolchain</a></h2>
<p>You will need the standard Rust toolchain, including <code>rustup</code>, <code>rustc</code>, and <code>cargo</code>.</p>
<p><a href="https://www.rust-lang.org/tools/install">Follow these instructions to install the Rust toolchain.</a></p>
<h2 id="setting-up-the-project"><a class="header" href="#setting-up-the-project">Setting up the project</a></h2>
<p>Let's get started and create our project. We will not use <code>cargo new --lib</code> yet;
instead, we will make an empty directory and initialize git.</p>
<pre><code class="language-bash">mkdir exa-lib
cd exa-lib
git init
</code></pre>
<blockquote>
<p><strong>📄 Note:</strong> <em>We initialized git that early, so when we create a new rust library,
it doesn’t come with a version control system; if you want to create a lib
without <code>vcs</code>, add <code>--vcs none</code> to your <code>cargo new</code> command.</em></p>
</blockquote>
<p>Each rust project (yes, we will create multiple rust projects) will be a member
of our <a href="https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html">cargo's workspace.</a></p>
<pre><code class="language-bash">touch Cargo.toml
</code></pre>
<p>We can now build our core library, iOS and Android glues.</p>
<pre><code class="language-bash">cargo new --lib exa_core
cargo new --lib glue/android
cargo new --lib glue/ios
</code></pre>
<p>The rust analyzer will go mad at us, so we should add them to our workspace.</p>
<pre><code class="language-toml">[workspace]
members = [
    &quot;exa_core&quot;,
    &quot;glue/android&quot;,
    &quot;glue/ios&quot;
]
</code></pre>
<p>And add one of the most essential files to git, <code>.gitignore</code></p>
<pre><code class="language-text">debug/
target/
Cargo.lock

**/*.rs.bk

*.pdb

.DS_Store

.idea/
.fleet/
.vscode/

main.rs
</code></pre>
<p>We are ignoring the <code>.lock</code> file since we’re building a library. And I also
like to ignore <code>main.rs</code> when building a library, so it acts as my playground
for drafting rust code, and indeed we don’t want that to be saved in the repo.</p>
<p>And for our last file for this section, the <code>.editorconfig</code></p>
<pre><code class="language-toml"># https://editorconfig.org

root = true

[*]
insert_final_newline = true
trim_trailing_whitespace = true
</code></pre>
<blockquote>
<p><strong>💡 Tip:</strong> <em>Install the <a href="https://editorconfig.org/">EditorConfig</a> extension
on your text editor if it doesn't support it out of the box.</em></p>
</blockquote>
<p>And we’re ending this chapter by adding a small function in <code>src/exa_core/lib.rs</code>
to greet someone.</p>
<pre><code class="language-rust">pub fn greet(person: &amp;str) -&gt; String {
    format!(&quot;Hello, {person}&quot;)
}

#[cfg(test)]
mod test {
    use super::*;

    #[test]
    fn it_greets() {
        let result = greet(&quot;World&quot;);
        assert_eq!(result, &quot;Hello, World&quot;);
    }
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup-makefile"><a class="header" href="#setup-makefile">Setup Makefile</a></h1>
<p>In this section we are going to create <code>Makefile</code> that will contain our commands.</p>
<pre><code class="language-bash">touch Makefile
</code></pre>
<p>We will start by adding android and iOS targets</p>
<pre><code class="language-Makefile">ios_targets = aarch64-apple-ios \
	x86_64-apple-ios \
	aarch64-apple-ios-sim

android_targets = armv7-linux-androideabi \
	i686-linux-android \
	aarch64-linux-android \
	x86_64-linux-android
</code></pre>
<p>Now we can loop over those targets to do whatever we want, as a beginning we
can add this targets to our tool chain under a setup command.</p>
<pre><code class="language-Makefile [hl 10-18]">ios_targets = aarch64-apple-ios \
	x86_64-apple-ios \
	aarch64-apple-ios-sim

android_targets = armv7-linux-androideabi \
	i686-linux-android \
	aarch64-linux-android \
	x86_64-linux-android

android-setup:
	@for target in ${android_targets} ; do \
        rustup target add $$target ; \
    done

ios-setup:
	@for target in ${ios_targets} ; do \
        rustup target add $$target ; \
    done
</code></pre>
<p>For iOS we also want to install <code>cargo-lipo</code>, which automatically creates a
universal library for use with your iOS application.</p>
<pre><code class="language-Makefile [hl 7]">android-setup:
	@for target in ${android_targets} ; do \
        rustup target add $$target ; \
    done

ios-setup:
	cargo install cargo-lipo

	@for target in ${ios_targets} ; do \
        rustup target add $$target ; \
    done
</code></pre>
<p>Now to set our iOS and android from rust side we run simple</p>
<pre><code class="language-bash">make ios-setup
make android-setup
</code></pre>
<blockquote>
<p><strong>📄 Note:</strong> <em>We should use hard tabs in our <code>Makefile</code>, spaces will result in
&quot;missing separator&quot;</em></p>
</blockquote>
<p>To make sure we use hard tabs we can add this rule in our <code>.editorconfig</code>.</p>
<pre><code class="language-toml [hl 9-11]"># https://editorconfig.org

root = true

[*]
insert_final_newline = true
trim_trailing_whitespace = true

[Makefile]
indent_style = tab
indent_size = 4
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ios-glue"><a class="header" href="#ios-glue">iOS Glue</a></h1>
<h2 id="library-target"><a class="header" href="#library-target">Library Target</a></h2>
<p>Make the crate type a static library inside <code>glue/ios/Cargo.toml</code>.</p>
<pre><code class="language-toml [hl 6-8]">[package]
name = &quot;ios&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[lib]
name = &quot;exa&quot;
crate-type = [&quot;staticlib&quot;]
</code></pre>
<p>Now we want to install our dependencies:</p>
<pre><code class="language-bash"># From the project root directory
cargo add -p ios --path ./exa_core/
cargo add -p ios libc
cargo add -p ios --build cbindgen
</code></pre>
<p>We want to export our library as C interfaces so that we can use C types and
C functions directly from Swift (or objective-c). <a href="https://developer.apple.com/documentation/swift/c-interoperability">C interoperability with Swift</a>.</p>
<blockquote>
<ul>
<li><em><code>exa_core</code>; our core library.</em></li>
<li><em><code>libc</code>; provides all of the definitions necessary to easily interoperate
with C code (or &quot;C-like&quot; code) on each of the platforms that Rust supports.</em></li>
<li><em><code>cbindgen</code> as build dependency; to generate our library's header file.</em></li>
</ul>
</blockquote>
<p>First we are going to use <code>cbindgen</code> to create a build script that runs on save,
we want our header file to be modified on change rather than manually writing it
down. So create <code>glue/ios/build.rs</code></p>
<pre><code class="language-rust">extern crate cbindgen;
use std::env;
use cbindgen::Language::C;

fn main() {
    setup_cbindgen();
}

fn setup_cbindgen() {
    let crate_dir = env::var(&quot;CARGO_MANIFEST_DIR&quot;);
    match crate_dir {
        Ok(val) =&gt; {
            cbindgen::Builder::new()
                .with_crate(val)
                .with_language(C)
                .generate()
                .expect(&quot;Unable to generate bindings&quot;)
                .write_to_file(&quot;include/exa_native.h&quot;);
        }
        Err(err) =&gt; {
            println!(&quot;Error: {}&quot;, err);
        }
    }
}</code></pre>
<p>Now the header file <code>exa_native.h</code> is going to live in
<code>glue/ios/include/exa_native.h</code>. For exporting it we will create <code>glue/ios/include/module.modulemap</code>.</p>
<pre><code class="language-modulemap">module Exa {
    header &quot;exa_native.h&quot;
    export *
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>


        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'G-M9GYS9Z1XC', 'auto');
                ga('send', 'pageview');
            }
        </script>


        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
